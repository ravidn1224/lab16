name: full CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPO: ${{ secrets.ECR_REPOSITORY }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION,AWS_ACCOUNT_ID,ECR_REPO

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
        - name: Checkout code
          uses: actions/checkout@v4
          
        - name: Set up Python
          uses: actions/setup-python@v4
          with:
                python-version: '3.11'

        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt

        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v3
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Login to Amazon ECR
          uses: aws-actions/amazon-ecr-login@v2

        - name: Run tests
          run: |
            pytest
            echo "Tests completed successfully"
        
        - name: Build, Tag, and Push Image
          env:
            ECR_REGISTRY: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          run: |
            IMAGE_URI=$ECR_REGISTRY/$ECR_REPO:latest
  
            docker build -t $IMAGE_URI .
            docker push $IMAGE_URI
  
            echo "Image pushed to $IMAGE_URI"

        # - name: Set up SSH
        #   uses: webfactory/ssh-agent@v0.9.0
        #   with:
            # ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
        
        - name: Deploy on EC2
          uses: appleboy/ssh-action@v0.1.10
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USER }}
            key: ${{ secrets.EC2_SSH_KEY }}
            envs: AWS_REGION,ECR_REPO,AWS_ACCOUNT_ID
            port: '22'
            script: |
                export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
                export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
                export AWS_REGION=$AWS_REGION
                export AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID
                export ECR_REPO=$ECR_REPO
                echo "üèÅ Checking system info..."
                hostname
                whoami
                uptime
              
                echo "üì¶ Installing AWS CLI & Docker..."
                sudo apt-get update
                sudo apt-get install -y awscli docker.io
              
                echo "üîë Giving user docker permissions..."
                sudo usermod -aG docker $USER
              
                echo "‚úÖ Checking installations..."
                aws --version
                docker --version
              
                IMAGE_URI=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:latest
              
                aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
              
                docker pull $IMAGE_URI
              
                docker stop myapp || true
                docker rm myapp || true
              
                docker run -d --name myapp -p 80:3000 $IMAGE_URI


      